# 简易更新记录

## 树新闻扩展
- `treenews.Event` 现携带 `ExchangeType (exchangeEnum.ExchangeType)` 与兼容的 `Exchange` 字段，`processMessage` 通过 `routeSymbols()` 在 Upbit / Binance 之间路由，并把枚举与字符串同时写入事件。
- `filter.go` 新增 Binance EN 专属提取器，支持 HODLer Airdrops 与 "Binance Will List" 格式的现货公告。
- `tree_news_bridge.go` 会根据 `ExchangeType` 调用 `Single.ReceiveTreeNews()`（Upbit）或 `ReceiveTreeNewsWithExchange(exchangeEnum.BINANCE)`，从而让策略侧记录树新闻来源。
- `Single` 结构新增 `treeNewsExchangeType`，`ReceiveTreeNewsWithExchange`/`ReceiveNoTreeNews` 负责维护该状态，`calParam()` 决策时会按照当前交易所对 gain/TWAP 进行差异化计算。

## 参数体系
- 新增 `rules_binance.go`，复制当前的市值分桶与系数，供 Binance 版本按需调整；`ExpectedSplitGainAndTwapDurationWithExchange()` 接受 `exchangeEnum.ExchangeType`，可根据交易所统一获取结果。
- `ComputeRequest` 支持 `Exchange` 字段，`Service.Compute()`、`clipGain`/`clipTwap` 会根据不同交易所读取对应的桶配置，保持 Upbit 行为兼容。

## 文档
- 补充并更新 `internal/strategy/toUpbitList/bn/toUpbitListBnSymbol/ReceiveTreeNews.md`，说明当前 `ReceiveTreeNews` 行为、枚举字段，以及未来扩展方向。

后续可在此文逐步更新不同交易所的具体参数与流程落地情况。

完整更新记录：
v1
Tree News 扩展

internal/strategy/treenews/tree_news_service.go (line 57) 现在让 Event 携带 Exchange，processMessage 通过新的 routeSymbols() 路由不同交易所，并把结果写回事件，后续 handler 可区分来源。
internal/strategy/treenews/filter.go (line 83)–134 新增 Binance EN 专用过滤/提取逻辑：仅在 source 为 “Binance EN” 且标题符合 “Binance Will List…” 或 “Introducing … HODLer Airdrops” 模式时提取括号内币种；同一个入口函数统一在 Upbit/Binance 间分派，方便继续扩展其他交易所。
internal/strategy/toUpbitList/bn/toUpbitListBnSymbolArr/tree_news_bridge.go (line 20)–35 handler 会记录 evt.Exchange，日志能够清楚区分从 Upbit 还是 Binance 收到的 Tree News。
参数体系

internal/strategy/toUpbitParam/rules.go (line 22)–145 引入交易所常量及 ExpectedSplitGainAndTwapDurationWithExchange()，让外部按交易所选择参数集；默认分支保持 Upbit 行为。
internal/strategy/toUpbitParam/rules_binance.go 复制当前市值分桶与系数，生成 Binance 版本的 expectedSplitGain/Twap 计算函数，用于后续按交易所调整 baseline/cap 或权重（目前数值与 Upbit 相同）。
文档

internal/strategy/toUpbitList/bn/toUpbitListBnSymbol/ReceiveTreeNews.md 记录 ReceiveTreeNews 的现状与未来扩展方向（区分交易所、携带新参数等）。
更新文档.md 汇总此次更新：Tree News 来源扩展、参数文件拆分以及新增文档，便于整个团队同步。

v2
Tree News 事件现在同时携带交易所字符串与 exchangeEnum.ExchangeType。internal/strategy/treenews/tree_news_service.go (line 58) 为 Event 增加 ExchangeType 字段，并在 processMessage 中调用新的 routeSymbols，把枚举与字符串一起写回事件，供后续处理使用。internal/strategy/treenews/filter.go (line 83) 之后的过滤函数返回 (ExchangeType, string, []string)，Upbit 和 Binance 事件会被路由到各自的枚举常量；未识别的 source 不会产生事件。

策略桥接层与参数接口已对齐。internal/strategy/toUpbitList/bn/toUpbitListBnSymbolArr/tree_news_bridge.go (line 30) 记录 evt.ExchangeType 并在日志中输出枚举和值，方便未来基于交易所分支。internal/strategy/toUpbitParam/rules.go (line 3) 引入 exchangeEnum，ExpectedSplitGainAndTwapDurationWithExchange 现在接受 ExchangeType 并按枚举选择 Upbit/Binance 的桶配置，原先的字符串常量已移除以避免重复维护。对应说明文档在 internal/strategy/toUpbitList/bn/toUpbitListBnSymbol/ReceiveTreeNews.md 更新了“区分交易所、参数来源”等小节，强调后续接口会直接传递枚举；更新文档.md 记录了本轮变更。为了验证链路，internal/strategy/treenews/manual_test.go 增加了对 evt.ExchangeType 的断言与日志。

测试：go test ./internal/strategy/treenews -run TestManualTreeNews -v（通过）。

v3
Tree News Flow

tree_news_bridge.go (line 31) now normalizes treenews.Event.ExchangeType, logs the source, and calls either the legacy ReceiveTreeNews() or the new ReceiveTreeNewsWithExchange(exchangeEnum.BINANCE) so Binance 上币公告会走单独分支。
to_upbit_bn_ex_treeNews.go (line 26) introduces ReceiveTreeNewsWithExchange, stores treeNewsExchangeType, and resets it back to Upbit when ReceiveNoTreeNews() fires, keeping Telegram 提醒不变。
Strategy Param Integration

to_upbit_bn_sy_trig_no.go (line 65) consults the stored treeNewsExchangeType when拉取止盈/止损参数，向 toUpbitBnMode.Mode 传递对应交易所，日志也带上来源，确保 Binance 事件得到独立的 gain/TWAP。
to_upbit_bn_mode.go (line 18) extends ModeBehavior 和各实现，使 GetTakeProfitParam 能接受交易所枚举并把它透传给参数服务。
to_upbit_bn_ex.go (line 33)/to_upbit_bn_sy.go (line 63) keep treeNewsExchangeType defaulting to Upbit so非树新闻流程维持原有行为。
参数服务

service.go (line 119) 的 ComputeRequest 新增 Exchange 字段，Compute() 会调用 ExpectedSplitGainAndTwapDurationWithExchange() 并用同一枚举驱动 clipGain/clipTwap，从而在一次调用内返回各交易所定制参数。
rules.go (line 135) 提供按交易所挑选的 gain/twap 分桶与裁剪逻辑（辅助函数 normalizeExchange / pick*ByExchange 保证默认仍是 Upbit）。
文档

internal/strategy/toUpbitList/bn/toUpbitListBnSymbol/ReceiveTreeNews.md 记录了现在的 Upbit/Binance 分支、何时覆盖参数以及后续扩展建议。
更新文档.md 同步描述树新闻/参数体系的改动，方便团队追踪。




现在的tree news流程：
Tree News 服务把事件分发到 tree_news_bridge.go (line 17) 注册的 handler；该 handler 将每个 symbols 转成 XXXUSDT，在 toUpBitListDataStatic.SymbolIndex 查到内部 symbolIndexTrue，同时根据 evt.ExchangeType 记录来源。
若符号在池中且就是当前触发品种 (toUpBitListDataAfter.TrigSymbolIndex)，则：
Upbit 事件调用 Single.ReceiveTreeNews()；
Binance 事件调用 Single.ReceiveTreeNewsWithExchange(exchangeEnum.BINANCE)，将 treeNewsExchangeType 保存为 BINANCE 并打出 “TreeNews确认” 推送。
Single 会继续执行原来的触发流程；当 calParam() 计算止盈/平仓参数时，会传入刚才的 treeNewsExchangeType，通过 toUpbitBnMode.Mode.GetTakeProfitParam(..., BINANCE) 调用参数服务，拿到 Binance 专属的 gain/TWAP。
参数服务 toUpbitParam.Service.Compute() 根据 ComputeRequest.Exchange 调整分桶/裁剪后返回这对值；Single.setExecuteParam 用新参数更新 takeProfitPrice 等执行状态。
若事件的符号和当前触发品种不一致，则对触发品种调用 ReceiveNoTreeNews()，清空 hasTreeNews 并回落到默认的 Upbit 参数。